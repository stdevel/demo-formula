---
name: CI
'on':
  pull_request:
  push:
    branches:
      - master
      - main
      - feat-rpm

jobs:
  #lint:
  #  name: lint
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Check-out code
  #      uses: actions/checkout@v2

  #    - name: Set-up Python 3
  #      uses: actions/setup-python@v2
  #      with:
  #        python-version: '3.x'

  #    - name: Install dependencies
  #      run: |
  #        pip3 install salt-lint
  #        sudo apt install rubocop

  #    - name: Lint code
  #      run: |
  #        salt-lint demo
  #        rubocop test/*.rb

  #kitchen:
  #  name: test-kitchen
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Check-out code
  #      uses: actions/checkout@v2

  #    - name: Set-up Python 3
  #      uses: actions/setup-python@v2
  #      with:
  #        python-version: '3.x'

  #    - name: Install dependencies
  #      run: |
  #        sudo apt install test-kitchen ruby-kitchen-salt ruby-kitchen-docker openssh-client
  #        sudo gem install inspec kitchen-inspec

  #    - name: Run test-kitchen tests
  #      run: |
  #        kitchen test

  rpm:
    name: create-rpm
    runs-on: ubuntu-latest
    steps:
      - name: Check-out code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get install -y tar gzip rpm

      - name: Build RPM
        run: |
          cd ..
          mv salt-tdd-example demo-formula-1.0
          tar cvfz /home/runner/rpmbuild/SOURCES/demo-formula-1.0.tar.gz demo-formula-1.0
          cd demo-formula-1.0
          mkdir dist
          rpmbuild -ba demo-formula.spec
          ls -laR /usr/src/packages
          mv /usr/src/packages/RPMS/noarch/*.rpm /usr/src/packages/SRPMS/*.rpm dist/

      - uses: actions/upload-artifact@v2
        with:
          name: rpm-artifact
          path: dist/
